<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecuRock | SOC Dashboard</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0b1015;
            /* Deep dark blue-gray */
            --bg-card: #151b23;
            --border-color: #30363d;
            --accent-primary: #58a6ff;
            --accent-danger: #f85149;
            --accent-warning: #d29922;
            --accent-success: #2ea043;
            --text-main: #e6edf3;
            --text-muted: #8b949e;
            --glow-red: 0 0 15px rgba(248, 81, 73, 0.4);
            --glow-green: 0 0 10px rgba(46, 160, 67, 0.3);
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Navbar */
        .navbar {
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            z-index: 1000;
        }

        .navbar-brand {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            color: var(--accent-primary) !important;
            letter-spacing: -0.5px;
            font-size: 1.25rem;
        }

        .status-badge {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid transparent;
            min-width: 140px;
            text-align: center;
            transition: all 0.3s ease;
        }

        /* Metrics Cards */
        .metric-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
            height: 100%;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border-color: var(--accent-primary);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 4px;
        }

        .border-danger-left::before {
            background-color: var(--accent-danger);
        }

        .border-warning-left::before {
            background-color: var(--accent-warning);
        }

        .border-success-left::before {
            background-color: var(--accent-success);
        }

        .border-primary-left::before {
            background-color: var(--accent-primary);
        }

        .metric-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
        }

        .metric-label {
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 1px;
        }

        /* Panel Styles */
        .panel-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            height: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .panel-header {
            background-color: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.25rem;
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 12px 12px 0 0;
        }

        /* Table Styles */
        .table-responsive {
            flex-grow: 1;
        }

        .table-custom {
            margin-bottom: 0;
            width: 100%;
        }

        .table-custom th {
            background-color: rgba(0, 0, 0, 0.2);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
            padding: 1rem;
        }

        .table-custom td {
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            padding: 1rem;
            transition: background 0.2s;
        }

        .table-custom tr:hover td {
            background-color: rgba(255, 255, 255, 0.02);
        }

        .expand-row {
            background-color: rgba(0, 0, 0, 0.3) !important;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .badge-custom {
            font-weight: 600;
            letter-spacing: 0.5px;
            padding: 0.4em 0.8em;
        }

        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 24px;
            border-left: 2px solid var(--border-color);
            margin: 10px 0 10px 10px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 24px;
            padding-left: 15px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -31px;
            top: 4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--bg-dark);
            border: 2px solid var(--text-muted);
            transition: all 0.3s;
        }

        /* Timeline Dot Colors */
        .timeline-item.t-critical::before {
            border-color: var(--accent-danger);
            background-color: var(--accent-danger);
            box-shadow: 0 0 8px var(--accent-danger);
        }

        .timeline-item.t-warning::before {
            border-color: var(--accent-warning);
            background-color: var(--accent-warning);
        }

        .timeline-item.t-safe::before {
            border-color: var(--accent-success);
            background-color: var(--accent-success);
        }

        /* Report Panel */
        .report-content {
            font-family: 'JetBrains Mono', monospace;
            background-color: #0d1117;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            color: var(--accent-primary);
            font-size: 0.85rem;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            box-shadow: inset 0 3px 10px rgba(0, 0, 0, 0.5);
            line-height: 1.5;
        }

        /* Auto Link Styling */
        .report-content strong {
            color: #fff;
        }

        /* Live Indicator */
        .live-dot {
            width: 10px;
            height: 10px;
            background-color: var(--accent-danger);
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            box-shadow: 0 0 8px var(--accent-danger);
            animation: pulse-live 2s infinite;
            vertical-align: middle;
        }

        .live-dot.status-ok {
            background-color: var(--accent-success);
            box-shadow: 0 0 8px var(--accent-success);
        }

        @keyframes pulse-live {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(0.9);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse-critical {
            0% {
                box-shadow: 0 0 0 0 rgba(248, 81, 73, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(248, 81, 73, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(248, 81, 73, 0);
            }
        }

        .status-safe {
            background-color: rgba(46, 160, 67, 0.1);
            color: var(--accent-success);
            border-color: rgba(46, 160, 67, 0.4);
            box-shadow: var(--glow-green);
        }

        .status-warning {
            background-color: rgba(210, 153, 34, 0.1);
            color: var(--accent-warning);
            border-color: rgba(210, 153, 34, 0.4);
        }

        .status-isolated {
            background-color: rgba(248, 81, 73, 0.1);
            color: var(--accent-danger);
            border-color: rgba(248, 81, 73, 0.4);
            animation: pulse-critical 2s infinite;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: #3d444d;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .btn-soc {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-main);
            transition: all 0.2s;
        }

        .btn-soc:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            background: rgba(88, 166, 255, 0.1);
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="logo.jpg" alt="SecuRock Logo" height="40" class="me-3 rounded-circle border border-primary">
                <div class="d-flex flex-column">
                    <span>SECUROCK</span>
                    <span class="text-white fw-light" style="font-size: 0.65rem; letter-spacing: 2px;">AUTOMATED
                        CYBERSECURITY</span>
                </div>
            </a>

            <div class="d-flex align-items-center gap-4">
                <div class="d-none d-md-flex align-items-center text-muted small fw-bold" style="letter-spacing: 1px;">
                    <span class="live-dot" id="liveIndicator"></span> LIVE MONITORING
                </div>

                <div id="systemStatusBadge" class="status-badge status-safe">
                    <i class="fas fa-check-circle me-2"></i>SAFE
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4 md:px-5 py-4">

        <!-- Offline Overlay Alert -->
        <div id="offlineAlert" class="alert alert-danger d-none shadow-lg border-danger" role="alert"
            style="border-left-width: 5px; background: #2a1215;">
            <div class="d-flex align-items-center">
                <i class="fas fa-wifi-slash fa-2x me-3"></i>
                <div>
                    <h5 class="alert-heading fw-bold mb-0">SOC BACKEND OFFLINE</h5>
                    <p class="mb-0 small opacity-75">Connection to Detection Engine lost. Dashboard is not receiving
                        live telemetry.</p>
                </div>
            </div>
        </div>

        <!-- Metrics Row -->
        <div class="row g-4 mb-4">
            <!-- Active Threats -->
            <div class="col-xl-3 col-md-6">
                <div class="metric-card p-4 border-danger-left">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="metric-label mb-2">Active Threats</p>
                            <h2 class="metric-value mb-0 text-white" id="metricActiveThreats">0</h2>
                        </div>
                        <div class="text-danger opacity-75">
                            <i class="fas fa-radiation fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Alerts -->
            <div class="col-xl-3 col-md-6">
                <div class="metric-card p-4 border-warning-left">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="metric-label mb-2">Total Incidents</p>
                            <h2 class="metric-value mb-0" id="metricTotalAlerts">0</h2>
                        </div>
                        <div class="text-warning opacity-75">
                            <i class="fas fa-bell fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Health -->
            <div class="col-xl-3 col-md-6">
                <div class="metric-card p-4 border-success-left">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="metric-label mb-2">System Health</p>
                            <h2 class="metric-value mb-0 text-success" id="metricHealth">100%</h2>
                        </div>
                        <div class="text-success opacity-75">
                            <i class="fas fa-heartbeat fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Responses -->
            <div class="col-xl-3 col-md-6">
                <div class="metric-card p-4 border-primary-left">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="metric-label mb-2">Auto-Responses</p>
                            <h2 class="metric-value mb-0" id="metricResponses">0</h2>
                        </div>
                        <div class="text-primary opacity-75">
                            <i class="fas fa-robot fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="row g-4 h-100">

            <!-- Left Column: Alerts Feed -->
            <div class="col-xl-8 col-lg-7 d-flex flex-column">
                <div class="panel-card flex-grow-1">
                    <div class="panel-header">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-list-ul me-2 text-primary"></i>
                            <span>THREAT FEED</span>
                        </div>
                        <div class="spinner-border spinner-border-sm text-secondary opacity-0" role="status"
                            id="loadingSpinner"></div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-custom mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 140px;">Timestamp</th>
                                    <th>Event Type</th>
                                    <th style="width: 100px;">Severity</th>
                                    <th style="width: 120px;">Status</th>
                                    <th>Auto-Response</th>
                                    <th style="width: 50px;"></th>
                                </tr>
                            </thead>
                            <tbody id="alertsTableBody">
                                <tr>
                                    <td colspan="6" class="text-center py-5 text-muted fst-italic">
                                        Initializing telemetry stream...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column: Timeline & Report -->
            <div class="col-xl-4 col-lg-5 d-flex flex-column gap-4">

                <!-- Status Timeline -->
                <div class="panel-card" style="max-height: 400px; min-height: 300px;">
                    <div class="panel-header">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-history me-2 text-primary"></i>
                            <span>ACTIVITY TIMELINE</span>
                        </div>
                    </div>
                    <div class="p-3 overflow-auto flex-grow-1">
                        <div class="timeline" id="eventTimeline">
                            <!-- JS populated -->
                            <div class="timeline-item t-safe">
                                <div class="text-muted small">Session Start</div>
                                <div class="fw-bold fs-6">Monitoring Initialized</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Incident Report -->
                <div class="panel-card flex-grow-1">
                    <div class="panel-header">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-invoice-dollar me-2 text-primary"></i>
                            <span>INCIDENT REPORT</span>
                        </div>
                        <div class="d-flex gap-2">
                            <button onclick="downloadReport()" class="btn btn-sm btn-soc px-3" title="Download Report">
                                <i class="fas fa-download"></i>
                            </button>
                            <button onclick="fetchReport()" class="btn btn-sm btn-soc px-3" title="Refresh">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-3 flex-grow-1">
                        <div id="incidentReportContent" class="report-content h-100">
                            NO ACTIVE INCIDENT.
                            System is operating within normal parameters.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        const API_BASE = "http://localhost:8000";
        let isOffline = false;

        // --- Core Fetch Loop ---
        async function fetchDashboardData() {
            const spinner = document.getElementById('loadingSpinner');
            spinner.classList.remove('opacity-0');

            try {
                // 1. Status
                const statusRes = await fetch(`${API_BASE}/status`);
                if (!statusRes.ok) throw new Error("Backend Error");

                // If success, clear offline state
                setOfflineState(false);

                const statusData = await statusRes.json();
                updateSystemStatus(statusData);

                // 2. Alerts
                const alertsRes = await fetch(`${API_BASE}/alerts`);
                const alertsData = await alertsRes.json();
                updateAlertsTable(alertsData);
                updateMetrics(alertsData, statusData);
                updateTimeline(alertsData);

                // 3. Auto-Fetch Report if Active Threat
                if (statusData.status !== 'SAFE') {
                    fetchReport();
                }

            } catch (error) {
                console.error("Sync Error:", error);
                setOfflineState(true);
            } finally {
                spinner.classList.add('opacity-0');
            }
        }

        // --- UI Updaters ---

        function setOfflineState(offline) {
            const alertBox = document.getElementById('offlineAlert');
            const liveDot = document.getElementById('liveIndicator');

            if (offline) {
                alertBox.classList.remove('d-none');
                liveDot.style.backgroundColor = '#6c757d'; // Gray
                liveDot.style.animation = 'none';
            } else {
                alertBox.classList.add('d-none');
                liveDot.style.animation = 'pulse-live 2s infinite';
            }
            isOffline = offline;
        }

        function updateSystemStatus(data) {
            const badge = document.getElementById('systemStatusBadge');
            const liveDot = document.getElementById('liveIndicator');
            const status = data.status.toUpperCase();

            let badgeClass = 'status-safe';
            let icon = 'fa-check-circle';
            let text = 'SYSTEM SAFE';
            let dotColor = '#2ea043'; // Green

            if (status === 'ISOLATED' || status === 'CRITICAL') {
                badgeClass = 'status-isolated';
                icon = 'fa-ban';
                text = 'SYSTEM ISOLATED';
                dotColor = '#f85149'; // Red
            } else if (status === 'WARNING') {
                badgeClass = 'status-warning';
                icon = 'fa-exclamation-triangle';
                text = 'THREAT DETECTED';
                dotColor = '#d29922'; // Yellow
            }

            badge.className = `status-badge ${badgeClass}`;
            badge.innerHTML = `<i class="fas ${icon} me-2"></i>${text}`;
            liveDot.style.backgroundColor = dotColor;
        }

        function updateAlertsTable(alerts) {
            const tbody = document.getElementById('alertsTableBody');

            if (alerts.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-5 text-muted opacity-50">No recent incidents logged.</td></tr>`;
                return;
            }

            let html = '';
            alerts.forEach(alert => {
                const date = new Date(alert.timestamp);
                const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                let sevClass = 'bg-secondary';
                if (alert.severity === 'HIGH') sevClass = 'bg-warning text-dark';
                if (alert.severity === 'CRITICAL') sevClass = 'bg-danger';
                if (alert.severity === 'LOW') sevClass = 'bg-info text-dark';

                // Status logic (Visual)
                const isMitigated = alert.action_taken !== 'MONITOR';
                const statusHtml = isMitigated
                    ? `<span class="text-success fw-bold"><i class="fas fa-check me-1"></i>MITIGATED</span>`
                    : `<span class="text-secondary"><i class="fas fa-eye me-1"></i>DETECTED</span>`;

                html += `
                    <tr onclick="toggleRow(this)">
                        <td class="font-monospace text-muted small">${timeStr}</td>
                        <td class="fw-bold">${alert.attack_type}</td>
                        <td><span class="badge ${sevClass} badge-custom">${alert.severity}</span></td>
                        <td>${statusHtml}</td>
                        <td class="text-warning font-class text-truncate" style="max-width: 150px;">
                             ${alert.action_taken !== 'MONITOR' ? '<i class="fas fa-bolt me-1"></i>' + alert.action_taken : '-'}
                        </td>
                        <td class="text-end text-muted"><i class="fas fa-chevron-down small"></i></td>
                    </tr>
                    <tr class="d-none expand-row">
                        <td colspan="6">
                            <div class="p-3 ms-4 border-start border-primary">
                                <div class="small text-muted text-uppercase mb-1">Incident Details</div>
                                <div class="text-white font-monospace mb-2">${alert.details}</div>
                                <div class="small text-muted text-uppercase mb-1">Action Log</div>
                                <div class="text-info font-monospace">${alert.action_taken}</div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        function toggleRow(row) {
            const next = row.nextElementSibling;
            if (next && next.classList.contains('expand-row')) {
                next.classList.toggle('d-none');
            }
        }

        function updateMetrics(alerts, statusData) {
            // Updated Count Logic: Active Threats = 0 if SAFE
            let activeThreats = 0;
            if (statusData.status !== 'SAFE') {
                activeThreats = alerts.filter(a => a.severity === 'HIGH' || a.severity === 'CRITICAL').length;
                if (activeThreats > 0) activeThreats = 1; // Simplify for demo visual
            }

            animateValue(document.getElementById('metricActiveThreats'), activeThreats);
            animateValue(document.getElementById('metricTotalAlerts'), alerts.length);

            // Health Logic
            const healthEl = document.getElementById('metricHealth');
            if (statusData.status === 'SAFE') {
                healthEl.innerHTML = "100%";
                healthEl.className = "metric-value mb-0 text-success";
            } else {
                healthEl.innerHTML = "CRITICAL";
                healthEl.className = "metric-value mb-0 text-danger";
            }

            // Responses
            const responses = alerts.filter(a => a.action_taken && a.action_taken !== 'MONITOR').length;
            animateValue(document.getElementById('metricResponses'), responses);
        }

        function updateTimeline(alerts) {
            const timeline = document.getElementById('eventTimeline');
            if (alerts.length === 0) return;

            let html = `<div class="timeline-item t-safe"><div class="text-muted small">Session Start</div><div class="fw-bold fs-6">Monitoring Active</div></div>`;

            // Show recent 5 in reverse for timeline visuals
            [...alerts].reverse().slice(0, 10).forEach(alert => {
                const time = new Date(alert.timestamp).toLocaleTimeString();

                let typeClass = 't-warning'; // default
                if (alert.severity === 'CRITICAL') typeClass = 't-critical';

                html += `
                    <div class="timeline-item ${typeClass}">
                        <div class="text-muted small font-monospace">${time}</div>
                        <div class="fw-bold fs-6">${alert.attack_type}</div>
                        <div class="small text-info mt-1">${alert.action_taken}</div>
                    </div>
                `;
            });

            timeline.innerHTML = html;
        }

        let lastReportText = "";
        async function fetchReport() {
            try {
                const res = await fetch(`${API_BASE}/report`);
                const data = await res.json();
                if (data.raw_text !== lastReportText) {
                    document.getElementById('incidentReportContent').innerText = data.raw_text;
                    lastReportText = data.raw_text;
                }
            } catch (e) { }
        }

        function downloadReport() {
            const content = document.getElementById('incidentReportContent').innerText;
            if (!content || content.includes("NO ACTIVE INCIDENT")) {
                alert("No active incident report to download.");
                return;
            }
            const element = document.createElement('a');
            const file = new Blob([content], { type: 'text/plain' });
            element.href = URL.createObjectURL(file);
            element.download = `SOC_Report_${new Date().toISOString().slice(0, 19).replace(/:/g, "-")}.txt`;
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        function animateValue(obj, end) {
            let start = parseInt(obj.innerText || 0);
            if (start === end) return;
            obj.innerHTML = end;
            // Simple flash effect on change
            obj.style.opacity = 0.5;
            setTimeout(() => obj.style.opacity = 1, 300);
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            fetchDashboardData();
            setInterval(fetchDashboardData, 3000);
        });

    </script>
</body>

</html>